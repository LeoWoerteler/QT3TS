<?xml version="1.0" encoding="UTF-8"?>
<test-set xmlns="http://www.w3.org/2010/09/qt-fots-catalog" name="fn-serialize" covers-30="fn-serialize">
    <description>Tests for the fn:serialize() function introduced in XPath 3.0</description>
    <link type="spec" document="http://www.w3.org/TR/xpath-functions-30/" idref="func-serialize-xml"/>

    <test-case name="serialize-xml-001">
        <description>serialize test</description>
        <created by="ONeil Delpratt, Saxonica" on="2010-10-05"/>
        <modified by="Michael Kay, Saxonica" on="2012-05-16" change="See bug 14279"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XP30+ XQ30+"/>
        <test>serialize(.)</test>
        <result>
            <assert>contains($result,'atomic')</assert>
        </result>
    </test-case>
    <test-case name="serialize-xml-002">
        <description>serialize test - with invalid attribute node</description>
        <created by="ONeil Delpratt, Saxonica" on="2010-10-05"/>
        <modified by="Michael Kay, Saxonica" on="2012-05-16" change="See bug 14279"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XP30+ XQ30+"/>
        <test>serialize((.//@*)[1])</test>
        <result>
            <error code="SENR0001"/>
        </result>
    </test-case>
    <test-case name="serialize-xml-003">
        <description>serialize test - with list of params as nodes</description>
        <created by="ONeil Delpratt, Saxonica" on="2010-10-05"/>
        <modified by="Michael Kay, Saxonica" on="2012-05-16" change="See bug 14279"/>
        <environment ref="atomic-xq"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
          let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization">
                <output:method value="xml"/>
                <output:indent value="yes"/>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <assert>contains($result,'atomic')</assert>
        </result>
    </test-case>
    <test-case name="serialize-xml-004">
        <description>serialize test - with list of properties, but no Method set</description>
        <created by="ONeil Delpratt, Saxonica" on="2010-10-05"/>
        <modified by="Michael Kay, Saxonica" on="2012-05-16" change="See bug 14279"/>
        <environment ref="atomic-xq"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
          let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization">
                <output:indent value="yes"/>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <assert>contains($result,'atomic')</assert>
        </result>
    </test-case>
    <test-case name="serialize-xml-005">
        <description>serialize test: Error - specified the use-character-map property</description>
        <created by="ONeil Delpratt, Saxonica" on="2010-10-05"/>
        <modified by="Michael Kay, Saxonica" on="2012-05-16" change="See bug 14279"/>
        <modified by="Michael Kay, Saxonica" on="2012-07-25" change="Change error code, see bug 14831"/>
        <environment ref="atomic-xq"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
          let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization">
                <output:use-character-maps value="yes"/>   
                <output:indent value="yes"/>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <error code="SEPM0017"/>
        </result>
    </test-case>
    <test-case name="serialize-xml-006">
        <description>serialize test: specified the cdata-section-element property, space separated
            QNames</description>
        <created by="ONeil Delpratt, Saxonica" on="2010-10-06"/>
        <modified by="Michael Kay, Saxonica" on="2012-05-16" change="See bug 14279"/>
        <environment ref="atomic-xq"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
          let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization"
                   xmlns:p="http://www.saxonica.com">
                <output:method value="xml"/>   
                <output:indent value="yes"/>
                <output:cdata-section-elements value="p:a p:b c"/>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <assert>contains($result,'atomic')</assert>
        </result>
    </test-case>
    <test-case name="serialize-xml-007">
        <description>serialize test: list of properties, but one is an unrecognized name 
            in a vendor namespace (no error, it is ignored)</description>
        <created by="ONeil Delpratt, Saxonica" on="2010-10-06"/>
        <modified by="Michael Kay, Saxonica" on="2012-05-16" change="See bug 14279"/>
        <modified by="Michael Kay, Saxonica" on="2012-07-25" change="Split test into two cases, where the extension
         is in the standard/vendor namespace respectively; assumes that the spec will reject the former and accept the latter"/>
        <environment ref="atomic-xq"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
          let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization">
                <output:method value="xml"/>   
                <output:indent value="yes"/>
                <output:xindent value="yes"/>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <error code="SEPM0017"/>
        </result>
    </test-case>
    <test-case name="serialize-xml-007a">
        <description>serialize test: list of properties, but one is an unrecognized name (no error,
            it is ignored)</description>
        <created by="ONeil Delpratt, Saxonica" on="2010-10-06"/>
        <modified by="Michael Kay, Saxonica" on="2012-05-16" change="See bug 14279"/>
        <modified by="Michael Kay, Saxonica" on="2012-07-25" change="Split test into two cases, where the extension
         in in the standard/vendor namespace respectively; assumes that the spec will reject the former and accept (ignore) the latter"/>
        <modified by="Michael Dyck" on="2012-09-04" change="Fix typo: insert missing slash"/>
        <environment ref="atomic-xq"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
          let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization">
                <output:method value="xml"/>   
                <output:indent value="yes"/>
                <vendor:xindent value="yes" xmlns:vendor="http://vendor.example.com/"/>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <assert>contains($result,'atomic')</assert>
        </result>
    </test-case>
    <test-case name="serialize-xml-008">
        <description>serialize test: New suppress-indentation parameter</description>
        <created by="Michael Kay, Saxonica" on="2010-10-07"/>
        <modified by="Michael Kay, Saxonica" on="2012-05-16" change="See bug 14279"/>
        <environment name="ser008">
          <source role="." file="serialize/serialize-008-src.xml">
            <description>File to be serialized</description>
            <created by="Michael Kay" on="2010-10-07"/>
          </source>
        </environment>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
          let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization">
                <output:method value="xml"/>   
                <output:indent value="yes"/>
                <output:suppress-indentation value="p"/>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <all-of>
                <assert>matches($result,'\n\s+&lt;title>')</assert>
                <assert>matches($result,'\n\s+&lt;p>')</assert>
                <assert>not(matches($result,'\n\s+&lt;code>'))</assert>
            </all-of>
        </result>
    </test-case>
    <test-case name="serialize-xml-009">
        <description>serialize test: Error - bad value for indent parameter</description>
        <created by="Michael Kay, Saxonica" on="2010-10-05"/>
        <modified by="Michael Kay, Saxonica" on="2012-05-16" change="See bug 14279"/>
        <modified by="Michael Kay, Saxonica" on="2012-07-25" change="Change error code, see bug 14831"/>
        <environment ref="atomic-xq"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
          let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization">
                <output:method value="xml"/>   
                <output:indent value="maybe"/>
                <output:suppress-indentation value="p"/>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <error code="SEPM0017"/>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-010">
        <description>Serialize a function item</description>
        <created by="Michael Kay, Saxonica" on="2013-04-23"/>
        <modified by="Josh Spiegel" on="2014-05-29" change="added dependency"/>
        <dependency type="spec" value="XP30+ XQ30+"/>
        <dependency type="feature" value="higherOrderFunctions"/>
        <test>serialize(name#1)</test>
        <result>
            <error code="SENR0001"/>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-011">
        <description>Serialize an attribute node</description>
        <created by="Michael Kay, Saxonica" on="2013-04-23"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XP30+ XQ30+"/>
        <test>serialize((//@*:attr)[1])</test>
        <result>
            <error code="SENR0001"/>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-012">
        <description>Serialize a namespace node</description>
        <created by="Michael Kay, Saxonica" on="2013-04-23"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XP30+"/>
        <test>serialize((//namespace::*)[1])</test>
        <result>
            <error code="SENR0001"/>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-013">
        <description>Serialize a namespace node</description>
        <created by="Michael Kay, Saxonica" on="2013-04-23"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XQ30+"/>
        <test>serialize(namespace a {"http://www.example.com"})</test>
        <result>
            <error code="SENR0001"/>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-014">
        <description>serialize test - with invalid attribute</description>
        <created by="Michael Kay" on="2015-04-16"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
            let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization">
                <output:indent value="yes" value2="no"/>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <error code="SEPM0017"/>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-015">
        <description>serialize test - with invalid attribute</description>
        <created by="Michael Kay" on="2015-04-16"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
            let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization"
                    value2="no">
                <output:indent value="yes"/>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <error code="SEPM0017"/>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-016">
        <description>serialize test - with disallowed element</description>
        <created by="Michael Kay" on="2015-04-16"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
            let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization">
                <output:indent value="yes"/>
                <output:outdent value="yes"/>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <error code="SEPM0017"/>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-017">
        <description>serialize test - with wrong namespace</description>
        <created by="Michael Kay" on="2015-04-16"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
            let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization/wrong">
                <output:indent value="yes"/>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <error code="XPTY0004"/>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-018">
        <description>serialize test - with wrong outermost element</description>
        <created by="Michael Kay" on="2015-04-16"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
            let $params := 
              <output:serialization-parameters-wrong
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization">
                <output:indent value="yes"/>
              </output:serialization-parameters-wrong>
          return serialize(., $params)
        ]]></test>
        <result>
            <error code="XPTY0004"/>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-019">
        <description>serialize test - with duplicated element</description>
        <created by="Michael Kay" on="2015-04-16"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
            let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization">
                <output:indent value="yes"/>
                <output:indent value="yes"/>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <error code="SEPM0019"/>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-020">
        <description>serialize test - with disallowed no-namespace element</description>
        <created by="Michael Kay" on="2015-04-16"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
            let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization">
                <indent value="yes"/>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <error code="SEPM0017"/>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-021">
        <description>serialize test - with bad attribute on character map</description>
        <created by="Michael Kay" on="2015-04-16"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
            let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization">
                <output:use-character-maps>
                  <output:character-map character="$" map-string="£" exchange-rate="1.80"/>
                </output:use-character-maps>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <error code="SEPM0017"/>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-022">
        <description>serialize test - with invalid child of character map</description>
        <created by="Michael Kay" on="2015-04-16"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
            let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization">
                <output:use-character-maps>
                  <output:character-map character="$" map-string="£" />
                  <output:character-mapping character="%" map-string="£"/>
                </output:use-character-maps>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <error code="SEPM0017"/>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-023">
        <description>serialize test - with character map - must be a single character</description>
        <created by="Michael Kay" on="2015-04-16"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
            let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization">
                <output:use-character-maps>
                  <output:character-map character="$$" map-string="£" />
                </output:use-character-maps>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <error code="SEPM0017"/>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-024">
        <description>serialize test - with character map - duplicate mappings</description>
        <created by="Michael Kay" on="2015-04-16"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
            let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization">
                <output:use-character-maps>
                  <output:character-map character="$" map-string="£" />
                  <output:character-map character="$" map-string="€" />
                </output:use-character-maps>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <error code="SEPM0018"/>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-025">
        <description>serialize test - with duplicated element in user namespace</description>
        <created by="Michael Kay" on="2015-04-16"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
            let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization"
                   xmlns:my-output="http://example.com/xslt-xquery-serialization">
                <my-output:indent-spaces value="3"/>
                <my-output:indent-spaces value="2"/>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <error code="SEPM0019"/>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-026">
        <description>serialize test - with ignored element in user namespace</description>
        <created by="Michael Kay" on="2015-04-16"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
            let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization"
                   xmlns:my-output="http://example.com/xslt-xquery-serialization">
                <output:indent value="yes"/>
                <my-output:indent-spaces value="2"/>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <assert>contains($result,'atomic')</assert>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-027">
        <description>serialize test - omit-xml-declaration</description>
        <created by="Michael Kay" on="2015-04-16"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
            let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization">
                <output:omit-xml-declaration value="yes"/>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <assert>not(contains($result,'&lt;?xml'))</assert>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-028">
        <description>serialize test - omit-xml-declaration</description>
        <created by="Michael Kay" on="2015-04-16"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
            let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization">
                <output:omit-xml-declaration value="no"/>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <assert>contains($result,'&lt;?xml')</assert>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-028">
        <description>serialize test - standalone</description>
        <created by="Michael Kay" on="2015-04-16"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
            let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization">
                <output:omit-xml-declaration value="no"/>
                <output:standalone value=" no "/>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <assert>contains($result,'standalone="no"')</assert>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-029">
        <description>serialize test - standalone</description>
        <created by="Michael Kay" on="2015-04-16"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
            let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization">
                <output:omit-xml-declaration value="no"/>
                <output:standalone value=" yes "/>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <assert>contains($result,'standalone="yes"')</assert>
        </result>
    </test-case>
    
    <test-case name="serialize-xml-030">
        <description>serialize test - standalone</description>
        <created by="Michael Kay" on="2015-04-16"/>
        <environment ref="atomic"/>
        <dependency type="spec" value="XQ30+"/>
        <test><![CDATA[
            let $params := 
              <output:serialization-parameters
                   xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization">
                <output:omit-xml-declaration value="no"/>
                <output:standalone value=" omit "/>
              </output:serialization-parameters>
          return serialize(., $params)
        ]]></test>
        <result>
            <assert>not(contains($result,'standalone'))</assert>
        </result>
    </test-case>
</test-set>
